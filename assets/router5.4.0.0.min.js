!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define("router5",["exports"],t):t(e.router5=e.router5||{})}(this,function(e){"use strict";function t(e){function t(t){var a=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],i=!(arguments.length<=2||void 0===arguments[2])&&arguments[2],o=arguments.length<=3||void 0===arguments[3]||arguments[3],u=e.getState();return!!u&&(i||u.name===t?n(e.makeState(t,a),u,o):r(e.makeState(t,a),u))}function n(t,n){var r=arguments.length<=2||void 0===arguments[2]||arguments[2];if(t.name!==n.name)return!1;var a=function(t){return e.rootNode.getSegmentsByName(t).map(function(e){return e.parser[r?"urlParams":"params"]}).reduce(function(e,t){return e.concat(t)},[])},i=a(t.name),o=a(n.name);return i.length===o.length&&i.every(function(e){return t.params[e]===n.params[e]})}function r(e,t){var n=new RegExp("^"+e.name+"\\.(.*)$");return!!n.test(t.name)&&Object.keys(e.params).every(function(n){return e.params[n]===t.params[n]})}function a(t,n){return e.rootNode.buildPath(t,n)}function i(t,n){return e.rootNode.buildState(t,n)}function o(t,n){var r=c.trailingSlash,a=c.strictQueryParams,i=e.rootNode.matchPath(t,{trailingSlash:r,strictQueryParams:a});return i?e.makeState(i.name,i.params,t,i._meta,n):null}function u(t){e.rootNode.setPath(t)}var c=e.getOptions();e.isActive=t,e.areStatesEqual=n,e.areStatesDescendants=r,e.buildPath=a,e.buildState=i,e.matchPath=o,e.setRootPath=u}function n(e){function t(){return a}function n(){var t=arguments.length<=arguments.length-1+0?void 0:arguments[arguments.length-1+0],n="function"==typeof t?t:$,r="function"!=typeof(arguments.length<=0?void 0:arguments[0])?arguments.length<=0?void 0:arguments[0]:void 0;if(a)return n({code:U.ROUTER_ALREADY_STARTED}),e;var o=void 0,u=void 0;a=!0,e.invokeEventListeners(D.ROUTER_START);var c=function(t,r){var a=arguments.length<=2||void 0===arguments[2]||arguments[2];t||e.invokeEventListeners(D.TRANSITION_SUCCESS,r,null,{replace:!0}),t&&a&&e.invokeEventListeners(D.TRANSITION_ERROR,r,null,t),n(t,r)};return void 0!==r||i.defaultRoute?("string"==typeof r?o=r:"object"===("undefined"==typeof r?"undefined":v.typeof(r))&&(u=r),u?(e.setState(u),n(null,u)):!function(){u=void 0===o?null:e.matchPath(o);var t=function(){return e.navigateToDefault({replace:!0},n)},r=function(t){return e.navigate(t.name,t.params,{replace:!0,reload:!0},n)};u?e.transitionToState(u,e.getState(),{},function(e,n){e?e.redirect?r(e.redirect):i.defaultRoute?t():c(e,null,!1):c(null,n)}):i.defaultRoute?t():i.allowNotFound?c(null,e.makeNotFoundState(o)):c({code:U.ROUTE_NOT_FOUND,path:o},null)}(),e):c({code:U.NO_START_PATH_OR_STATE})}function r(){return a&&(e.setState(null),a=!1,e.invokeEventListeners(D.ROUTER_STOP)),e}var a=!1,i=e.getOptions();e.isStarted=t,e.start=n,e.stop=r}function r(e){return e.split(".").reduce(function(e,t){return e.concat(e.length?e[e.length-1]+"."+t:t)},[])}function a(e,t){return t._meta&&t._meta[e]?Object.keys(t._meta[e]).reduce(function(e,n){return e[n]=t.params[n],e},{}):{}}function i(e,t){function n(){var n=void 0,r=function(){var r=i[n],u=o[n];if(r!==u)return{v:n};var c=a(r,e),s=a(u,t);if(c.length!==s.length)return{v:n};if(0===c.length)return"continue";var l=Object.keys(c).some(function(e){return s[e]!==c[e]});return l?{v:n}:void 0};for(n=0;n<u;n+=1){var c=r();switch(c){case"continue":continue;default:if("object"===("undefined"==typeof c?"undefined":v.typeof(c)))return c.v}}return n}var i=t?r(t.name):[],o=r(e.name),u=Math.min(i.length,o.length),c=void 0;t?t&&(e.name!==t.name||e._meta&&t._meta)?c=n():(console.log("[router5.transition-path] Some states are missing metadata, reloading all segments"),c=0):c=0;var s=i.slice(c).reverse(),l=o.slice(c),f=t&&c>0?i[c-1]:"";return{intersection:f,toDeactivate:s,toActivate:l}}function o(e,t,n){var r=t.isCancelled,a=t.toState,i=t.fromState,o=t.errorKey,u=Array.isArray(e)?e:Object.keys(e),c=function(e){return"object"===("undefined"==typeof e?"undefined":v.typeof(e))&&void 0!==e.name&&void 0!==e.params&&void 0!==e.path},s=function(e){return e.name!==a.name||e.params!==a.params||e.path!==a.path},l=function(t){if(!u.length)return!0;var n="string"==typeof u[0],c=o&&n?v.defineProperty({},o,u[0]):{},s=n?e[u[0]]:u[0],l=s.call(null,a,i,t);return r()?t(null):"boolean"==typeof l?t(l?null:c):l&&"function"==typeof l.then&&l.then(function(e){e instanceof Error?t({error:e},null):t(null,e)},function(e){e instanceof Error?(console.error(e.stack||e),t(v.extends({},c,{promiseError:e}),null)):t("object"===("undefined"==typeof e?"undefined":v.typeof(e))?v.extends({},c,e):c,null)}),!1},f=function(e,t){r()?n():e?n(e):(t&&c(t)&&(s(t)&&console.error("[router5][transition] Warning: state values changed during transition process."),a=t),u=u.slice(1),d())},d=function(){if(r())n();else{var e=l(f);e&&n(null,a)}};d()}function u(e,t,n,a,u){var c=!1,s=!1,l=e.getOptions(),f=e.getLifecycleFunctions(),d=v.slicedToArray(f,2),h=d[0],p=d[1],m=e.getMiddlewareFunctions(),g=function(){return c},y=function(){c||s||(c=!0,u({code:U.TRANSITION_CANCELLED},null))},T=function(n,a){s=!0,g()||(!n&&l.autoCleanUp&&!function(){var n=r(t.name);Object.keys(h).forEach(function(t){n.indexOf(t)===-1&&e.clearCanDeactivate(t)})}(),u(n,a||t))},S=function(e,t){return v.extends({},e,t instanceof Object?t:{error:t})},A=i(t,n),E=A.toDeactivate,R=A.toActivate,O={isCancelled:g,toState:t,fromState:n},N=function(e,t,n){var r=E.filter(function(e){return h[e]}).reduce(function(e,t){return v.extends({},e,v.defineProperty({},t,h[t]))},{});o(r,v.extends({},O,{errorKey:"segment"}),function(e){return n(e?S({code:U.CANNOT_DEACTIVATE},e):null)})},_=function(e,t,n){var r=R.filter(function(e){return p[e]}).reduce(function(e,t){return v.extends({},e,v.defineProperty({},t,p[t]))},{});o(r,v.extends({},O,{errorKey:"segment"}),function(e){return n(e?S({code:U.CANNOT_ACTIVATE},e):null)})},P=m.length?function(e,t,n){return o(m,v.extends({},O),function(t,r){return n(t?S({code:U.TRANSITION_ERR},t):null,r||e)})}:[],b=(n&&!a.forceDeactivate?[N]:[]).concat(_).concat(P);return o(b,O,T),y}function c(e){function t(){return i&&(i("navigate"),i=null),e}function n(){var t=arguments.length<=0?void 0:arguments[0],r=arguments.length<=arguments.length-1+0?void 0:arguments[arguments.length-1+0],i="function"==typeof r?r:$,o="object"===v.typeof(arguments.length<=1?void 0:arguments[1])?arguments.length<=1?void 0:arguments[1]:{},u="object"===v.typeof(arguments.length<=2?void 0:arguments[2])?arguments.length<=2?void 0:arguments[2]:{};if(!e.isStarted())return void i({code:U.ROUTER_NOT_STARTED});var c=e.buildState(t,o);if(!c){var s={code:U.ROUTE_NOT_FOUND};return i(s),void e.invokeEventListeners(D.TRANSITION_ERROR,null,e.getState(),s)}c.path=e.buildPath(t,o);var l=!!e.getState()&&e.areStatesEqual(e.getState(),c,!1);if(l&&!u.reload){var f={code:U.SAME_STATES};return i(f),void e.invokeEventListeners(D.TRANSITION_ERROR,c,e.getState(),f)}var d=l?null:e.getState();return a(c,d,u,function(t,r){if(t)if(t.redirect){var a=t.redirect,o=a.name,c=a.params;n(o,c,v.extends({},u,{reload:!0}),i)}else i(t);else e.invokeEventListeners(D.TRANSITION_SUCCESS,r,d,u),i(null,r)})}function r(){var t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],r=arguments.length<=1||void 0===arguments[1]?$:arguments[1],a=e.getOptions();return n(a.defaultRoute,a.defaultParams,t,r)}function a(n,r){var a=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],o=arguments.length<=3||void 0===arguments[3]?$:arguments[3];return t(),e.invokeEventListeners(D.TRANSITION_START,n,r),i=u(e,n,r,a,function(t,a){i=null,a=a||n,t?(t.code===U.TRANSITION_CANCELLED?e.invokeEventListeners(D.TRANSITION_CANCELLED,n,r):e.invokeEventListeners(D.TRANSITION_ERROR,n,r,t),o(t)):(e.setState(a),o(null,a))})}var i=void 0;e.navigate=n,e.navigateToDefault=r,e.transitionToState=a,e.cancel=t}function s(e){function t(){for(var t=arguments.length,n=Array(t),r=0;r<t;r++)n[r]=arguments[r];return n.forEach(a),e}function n(){o=[],u=[]}function r(){return u}function a(e){o.push(e),i(e)}function i(t){u.push(e.executeFactory(t))}var o=[],u=[];e.useMiddleware=t,e.getMiddlewareFunctions=r,e.clearMiddleware=n}function l(e){function t(){for(var t=arguments.length,r=Array(t),a=0;a<t;a++)r[a]=arguments[a];return r.forEach(n),e}function n(e){r(e)||(i.push(e),a(e))}function r(e){return i.filter(function(t){return t.name===e}).length>0}function a(t){var n=e.executeFactory(t),r=L.map(function(t){if(n[t])return e.addEventListener(t.toLowerCase().replace(/^on/,"$$").replace(/transition/,"$$"),n[t])}).filter(Boolean);o.push.apply(o,v.toConsumableArray(r))}var i=[],o=[];e.usePlugin=t,e.hasPlugin=r}function f(e){function t(){return[s,u]}function n(t,n){var r=F(n);return c[t]=r,e.isStarted()&&(s[t]=e.executeFactory(r)),e}function r(e){c[e]=void 0,s[e]=void 0}function a(t,n){var r=F(n);return o[t]=r,e.isStarted()&&(u[t]=e.executeFactory(r)),e}function i(){var t=function(t){return Object.keys(t).reduce(function(n,r){return t[r]&&(n[r]=e.executeFactory(t[r])),n},{})};u=t(o),s=t(c)}var o={},u={},c={},s={};e.canDeactivate=n,e.canActivate=a,e.getLifecycleFunctions=t,e.clearCanDeactivate=r,e.addEventListener(D.ROUTER_START,i)}function d(e,r){function a(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];(P[e]||[]).forEach(function(e){return e.apply(void 0,n)})}function i(e,t){P[e]=P[e].filter(function(e){return e!==t})}function o(e,t){return P[e]=(P[e]||[]).concat(t),function(){return i(e,t)}}function u(e){e.canActivate&&C.canActivate(e.name,e.canActivate)}function d(e,t,n,r,a){var i={},o=function(e,t){return Object.defineProperty(i,e,{value:t,enumerable:!0})};if(o("name",e),o("params",t),o("path",n),r||a){var u={params:r};a&&(u.source=a),o("meta",u)}return i}function h(e){return d(D.UNKNOWN_ROUTE,{path:e},e,{})}function p(){return _}function m(e){_=e}function g(){return k}function y(e,t){return k[e]=t,C}function T(e,t){return b[e]=t,C}function S(e){Object.keys(e).forEach(function(t){b[t]=e[t]})}function A(){return b}function E(){return[C,b]}function R(e){return e.apply(void 0,v.toConsumableArray(E()))}function O(e){return x.add(e,u),C}function N(e,t,n){return x.addNode(e,t),n&&C.canActivate(e,n),C}var _=null,P={},b={},k=v.extends({},q,r),C={rootNode:x,getOptions:g,setOption:y,getState:p,setState:m,makeState:d,makeNotFoundState:h,setDependency:T,setDependencies:S,getDependencies:A,add:O,addNode:N,executeFactory:R,addEventListener:o,removeEventListener:i,invokeEventListeners:a};t(C),l(C),s(C),f(C),n(C),c(C);var x=e instanceof j?e:new j("","",e,u);return C.rootNode=x,C}function h(){var e=function(){return console.group("Router transition")},t=function(){return console.groupEnd("Router transition")};return console.info("Router started"),{onStop:function(){console.info("Router stopped")},onTransitionStart:function(n,r){t(),e(),console.log("Transition started from state"),console.log(r),console.log("To state"),console.log(n)},onTransitionCancel:function(){console.warn("Transition cancelled")},onTransitionError:function(e,n,r){console.warn("Transition error with code "+r.code),t()},onTransitionSuccess:function(){console.log("Transition success"),t()}}}var v={};v.typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},v.classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},v.createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),v.defineProperty=function(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e},v.extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},v.slicedToArray=function(){function e(e,t){var n=[],r=!0,a=!1,i=void 0;try{for(var o,u=e[Symbol.iterator]();!(r=(o=u.next()).done)&&(n.push(o.value),!t||n.length!==t);r=!0);}catch(e){a=!0,i=e}finally{try{!r&&u.return&&u.return()}finally{if(a)throw i}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),v.toConsumableArray=function(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)};var p=function(e){return"("+(e?e.replace(/(^<|>$)/g,""):"[a-zA-Z0-9-_.~%]+")+")"},m=[{name:"url-parameter",pattern:/^:([a-zA-Z0-9-_]*[a-zA-Z0-9]{1})(<(.+?)>)?/,regex:function(e){return new RegExp(p(e[2]))}},{name:"url-parameter-splat",pattern:/^\*([a-zA-Z0-9-_]*[a-zA-Z0-9]{1})/,regex:/([^\?]*)/},{name:"url-parameter-matrix",pattern:/^\;([a-zA-Z0-9-_]*[a-zA-Z0-9]{1})(<(.+?)>)?/,regex:function(e){return new RegExp(";"+e[1]+"="+p(e[2]))}},{name:"query-parameter-bracket",pattern:/^(?:\?|&)(?:\:)?([a-zA-Z0-9-_]*[a-zA-Z0-9]{1})(?:\[\])/},{name:"query-parameter",pattern:/^(?:\?|&)(?:\:)?([a-zA-Z0-9-_]*[a-zA-Z0-9]{1})/},{name:"delimiter",pattern:/^(\/|\?)/,regex:function(e){return new RegExp("\\"+e[0])}},{name:"sub-delimiter",pattern:/^(\!|\&|\-|_|\.|;)/,regex:function(e){return new RegExp(e[0])}},{name:"fragment",pattern:/^([0-9a-zA-Z]+)/,regex:function(e){return new RegExp(e[0])}}],g=function e(t){var n=arguments.length<=1||void 0===arguments[1]?[]:arguments[1],r=m.some(function(r){var a=t.match(r.pattern);return!!a&&(n.push({type:r.name,match:a[0],val:a.slice(1,2),otherVal:a.slice(2),regex:r.regex instanceof Function?r.regex(a):r.regex}),a[0].length<t.length&&(n=e(t.substr(a[0].length),n)),!0)});if(!r)throw new Error("Could not parse path.");return n},y=function(e,t){return t?e.replace(/\\\/$/,"")+"(?:\\/)?":e},T=function(e){return e.replace(/\[\]$/,"")},S=function(e,t){var n=arguments.length<=2||void 0===arguments[2]?"":arguments[2];/\[\]$/.test(t)&&(t=T(t),n=[n]);var r=e[t];return void 0===r?e[t]=n:e[t]=Array.isArray(r)?r.concat(n):[r,n],e},A=function(e){var t=e.split("?")[1];return t?t.split("&").map(function(e){return e.split("=")}).reduce(function(e,t){return S(e,t[0],t[1]?decodeURIComponent(t[1]):t[1])},{}):{}},E=function(e){return void 0!==e&&null!==e&&""!==e?"="+e:""},R=function e(t,n){return Array.isArray(n)?n.map(function(n){return e(t,n)}).join("&"):t+E(n)},O=function(){function e(t){if(v.classCallCheck(this,e),!t)throw new Error("Please supply a path");this.path=t,this.tokens=g(t),this.hasUrlParams=this.tokens.filter(function(e){return/^url-parameter/.test(e.type)}).length>0,this.hasSpatParam=this.tokens.filter(function(e){return/splat$/.test(e.type)}).length>0,this.hasMatrixParams=this.tokens.filter(function(e){return/matrix$/.test(e.type)}).length>0,this.hasQueryParams=this.tokens.filter(function(e){return/^query-parameter/.test(e.type)}).length>0,this.urlParams=this.hasUrlParams?this.tokens.filter(function(e){return/^url-parameter/.test(e.type)}).map(function(e){return e.val.slice(0,1)}).reduce(function(e,t){return e.concat(t)}):[],this.queryParams=this.hasQueryParams?this.tokens.filter(function(e){return"query-parameter"===e.type}).map(function(e){return e.val}).reduce(function(e,t){return e.concat(t)},[]):[],this.queryParamsBr=this.hasQueryParams?this.tokens.filter(function(e){return/-bracket$/.test(e.type)}).map(function(e){return e.val}).reduce(function(e,t){return e.concat(t)},[]):[],this.params=this.urlParams.concat(this.queryParams).concat(this.queryParamsBr),this.source=this.tokens.filter(function(e){return void 0!==e.regex}).map(function(e){return e.regex.source}).join("")}return v.createClass(e,null,[{key:"createPath",value:function(t){return new e(t)}},{key:"serialise",value:function(e,t){return R(e,t)}}]),v.createClass(e,[{key:"_urlMatch",value:function(e,t){var n=this,r=e.match(t);return r?this.urlParams.length?r.slice(1,this.urlParams.length+1).reduce(function(e,t,r){return e[n.urlParams[r]]=decodeURIComponent(t),e},{}):{}:null}},{key:"match",value:function(e){var t=this,n=arguments.length<=1||void 0===arguments[1]?0:arguments[1],r=y(this.source,n),a=this._urlMatch(e,new RegExp("^"+r+(this.hasQueryParams?"(\\?.*$|$)":"$")));if(!a||!this.hasQueryParams)return a;var i=A(e),o=Object.keys(i).filter(function(e){return t.queryParams.concat(t.queryParamsBr).indexOf(e)===-1});return 0===o.length?(Object.keys(i).forEach(function(e){return a[e]=i[e]}),a):null}},{key:"partialMatch",value:function(e){var t=this,n=arguments.length<=1||void 0===arguments[1]?0:arguments[1],r=y(this.source,n),a=this._urlMatch(e,new RegExp("^"+r));if(!a)return a;if(!this.hasQueryParams)return a;var i=A(e);return Object.keys(i).filter(function(e){return t.queryParams.concat(t.queryParamsBr).indexOf(e)>=0}).forEach(function(e){return S(a,e,i[e])}),a}},{key:"build",value:function(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],t=arguments.length<=1||void 0===arguments[1]?{ignoreConstraints:!1,ignoreSearch:!1}:arguments[1],n=Object.keys(e).reduce(function(t,n){return void 0===e[n]?t[n]=void 0:t[n]=Array.isArray(e[n])?e[n].map(encodeURI):encodeURI(e[n]),t},{});if(this.urlParams.some(function(t){return void 0===e[t]}))throw new Error("Missing parameters");if(!t.ignoreConstraints){var r=this.tokens.filter(function(e){return/^url-parameter/.test(e.type)&&!/-splat$/.test(e.type)}).every(function(e){return new RegExp("^"+p(e.otherVal[0])+"$").test(n[e.val])});if(!r)throw new Error("Some parameters are of invalid format")}var a=this.tokens.filter(function(e){return/^query-parameter/.test(e.type)===!1}).map(function(e){return"url-parameter-matrix"===e.type?";"+e.val+"="+n[e.val[0]]:/^url-parameter/.test(e.type)?n[e.val[0]]:e.match}).join("");if(t.ignoreSearch)return a;var i=this.queryParams.concat(this.queryParamsBr.map(function(e){return e+"[]"})),o=i.filter(function(e){return Object.keys(n).indexOf(T(e))!==-1}).map(function(e){return R(e,n[T(e)])}).join("&");return a+(o?"?"+o:"")}}]),e}(),N=function(e){return e.split("?")[0]},_=function(e){return e.split("?")[1]},P=function(e){return void 0!==e&&null!==e&&""!==e},b=/\[\]$/,k=function(e){return e.replace(b,"")},C=function(e){return e.split("&").reduce(function(e,t){var n=t.split("="),r=n[0],a=n[1];return e.concat({name:r,value:decodeURIComponent(a)})},[])},x=function(e){return e.map(function(e){var t=e.name,n=e.value;return[t].concat(P(n)?encodeURIComponent(n):[])}).map(function(e){return e.join("=")}).join("&")},w=function(e,t){if(!e)return"";var n=C(e).filter(function(e){var n=e.name;return t.indexOf(k(n))===-1}),r=x(n);return r||""},I=function(){},j=function(){function e(){var t=arguments.length<=0||void 0===arguments[0]?"":arguments[0],n=arguments.length<=1||void 0===arguments[1]?"":arguments[1],r=arguments.length<=2||void 0===arguments[2]?[]:arguments[2],a=arguments[3];return v.classCallCheck(this,e),this.name=t,this.path=n,this.parser=n?new O(n):null,this.children=[],this.add(r,a),this}return v.createClass(e,[{key:"setPath",value:function(){var e=arguments.length<=0||void 0===arguments[0]?"":arguments[0];this.path=e,this.parser=e?new O(e):null}},{key:"add",value:function(t){var n=this,r=arguments.length<=1||void 0===arguments[1]?I:arguments[1],a=void 0;if(void 0!==t&&null!==t){if(t instanceof Array)return void t.forEach(function(e){return n.add(e,r)});if(!(t instanceof e||t instanceof Object))throw new Error("RouteNode.add() expects routes to be an Object or an instance of RouteNode.");if(t instanceof Object){if(!t.name||!t.path)throw new Error("RouteNode.add() expects routes to have a name and a path defined.");a=t,t=new e(t.name,t.path,t.children,r)}var i=t.name.split(".");if(1===i.length){if(this.children.map(function(e){return e.name}).indexOf(t.name)!==-1)throw new Error('Alias "'+t.name+'" is already defined in route node');if(this.children.map(function(e){return e.path}).indexOf(t.path)!==-1)throw new Error('Path "'+t.path+'" is already defined in route node');this.children.push(t),this.children.sort(function(e,t){var n=e.path.split("?")[0].replace(/(.+)\/$/,"$1"),r=t.path.split("?")[0].replace(/(.+)\/$/,"$1");if("/"===n)return 1;if("/"===r)return-1;if(e.parser.hasSpatParam)return 1;if(t.parser.hasSpatParam)return-1;var a=(n.match(/\//g)||[]).length,i=(r.match(/\//g)||[]).length;if(a<i)return 1;if(a>i)return-1;var o=e.parser.urlParams.length,u=t.parser.urlParams.length;if(o<u)return-1;if(o>u)return 1;var c=(n.split("/").slice(-1)[0]||"").length,s=(r.split("/").slice(-1)[0]||"").length;return c<s?1:c>s?-1:0})}else{var o=this.getSegmentsByName(i.slice(0,-1).join("."));if(!o)throw new Error("Could not add route named '"+t.name+"', parent is missing.");o[o.length-1].add(new e(i[i.length-1],t.path,t.children))}return a&&r(a),this}}},{key:"addNode",value:function(t,n){return this.add(new e(t,n)),this}},{key:"getSegmentsByName",value:function(e){var t=function(e,t){var n=t.filter(function(t){return t.name===e});return n.length?n[0]:void 0},n=[],r=this.parser?[this]:this.children,a=(this.parser?[""]:[]).concat(e.split(".")),i=a.every(function(e){var a=t(e,r);return!!a&&(r=a.children,n.push(a),!0)});return i?n:null}},{key:"getSegmentsMatchingPath",value:function(e,t){var n=t.trailingSlash,r=t.strictQueryParams,a=function e(t,a,i){var o=function(o){var u=t[o],c=u.parser.partialMatch(a),s=void 0;if(!c&&n)c=u.parser.match(a,!0),s="";else if(c){var l=u.parser.build(c,{ignoreSearch:!0});s=a.replace(l,"");var f=w(_(a.replace(l,"")),u.parser.queryParams.concat(u.parser.queryParamsBr));s=N(s)+(f?"?"+f:""),n&&"/"===s&&!/\/$/.test(l)&&(s="")}if(c)return i.push(u),Object.keys(c).forEach(function(e){return i.params[e]=c[e]}),!s.length||!r&&0===s.indexOf("?")?{v:i}:u.children.length?{v:e(u.children,s,i)}:{v:null}};for(var u in t){var c=o(u);if("object"===("undefined"==typeof c?"undefined":v.typeof(c)))return c.v}return null},i=this.parser?[this]:this.children,o=[];o.params={};var u=a(i,e,o);return u&&1===u.length&&""===u[0].name?null:u}},{key:"getPathFromSegments",value:function(e){return e?e.map(function(e){return e.path}).join(""):null}},{key:"getPath",value:function(e){return this.getPathFromSegments(this.getSegmentsByName(e))}},{key:"buildPathFromSegments",value:function(e){var t=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];if(!e)return null;var n=e.filter(function(e){return e.parser.hasQueryParams}).reduce(function(e,t){return e.concat(t.parser.queryParams).concat(t.parser.queryParamsBr.map(function(e){return e+"[]"}))},[]),r=n.length?n.filter(function(e){return Object.keys(t).indexOf(k(e))!==-1}).map(function(e){var n=t[k(e)],r=Array.isArray(n)?n.map(encodeURIComponent):encodeURIComponent(n);return O.serialise(e,r)}).join("&"):null;return e.map(function(e){return e.parser.build(t,{ignoreSearch:!0})}).join("")+(r?"?"+r:"")}},{key:"getMetaFromSegments",value:function(e){var t="";return e.reduce(function(e,n){var r=n.parser.urlParams.reduce(function(e,t){return e[t]="url",e},{}),a=n.parser.queryParams.reduce(function(e,t){return e[t]="query",e},r);return void 0!==n.name&&(t=t?t+"."+n.name:n.name,e[t]=a),e},{})}},{key:"buildPath",value:function(e){var t=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];return this.buildPathFromSegments(this.getSegmentsByName(e),t)}},{key:"buildStateFromSegments",value:function(e){if(!e||!e.length)return null;var t=e.map(function(e){return e.name}).filter(function(e){return e}).join("."),n=e.params;return{name:t,params:n,_meta:this.getMetaFromSegments(e)}}},{key:"buildState",value:function(e){var t=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],n=this.getSegmentsByName(e);return n&&n.length?{name:e,params:t,_meta:this.getMetaFromSegments(n)}:null}},{key:"matchPath",value:function(e,t){var n={trailingSlash:!1,strictQueryParams:!0};return t=v.extends({},n,t),this.buildStateFromSegments(this.getSegmentsMatchingPath(e,t))}}]),e}(),U={ROUTER_NOT_STARTED:"NOT_STARTED",NO_START_PATH_OR_STATE:"NO_START_PATH_OR_STATE",ROUTER_ALREADY_STARTED:"ALREADY_STARTED",ROUTE_NOT_FOUND:"ROUTE_NOT_FOUND",SAME_STATES:"SAME_STATES",CANNOT_DEACTIVATE:"CANNOT_DEACTIVATE",CANNOT_ACTIVATE:"CANNOT_ACTIVATE",TRANSITION_ERR:"TRANSITION_ERR",TRANSITION_CANCELLED:"CANCELLED"},D={UNKNOWN_ROUTE:"@@router5/UNKNOWN_ROUTE",ROUTER_START:"$start",ROUTER_STOP:"$stop",TRANSITION_START:"$$start",TRANSITION_CANCEL:"$$cancel",TRANSITION_SUCCESS:"$$success",TRANSITION_ERROR:"$$error"},$=function(){},L=["onStart","onStop","onTransitionSuccess","onTransitionStart","onTransitionError","onTransitionCancel"],F=function(e){return"function"==typeof e?e:function(){return function(){return e}}},q={trailingSlash:0,autoCleanUp:!0,strictQueryParams:!0,allowNotFound:!1};e.default=d,e.createRouter=d,e.RouteNode=j,e.loggerPlugin=h,e.errorCodes=U,e.transitionPath=i,e.constants=D,Object.defineProperty(e,"__esModule",{value:!0})});

!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define("router5BrowserPlugin",t):e.router5BrowserPlugin=t()}(this,function(){"use strict";function e(e,t){function a(a,n){return(t.base||"")+(t.useHash?"#"+t.hashPrefix:"")+e.buildPath(a,n)}function n(e){var a=e.match(/^(?:http|https)\:\/\/(?:[0-9a-z_\-\.\:]+?)(?=\/)(.*)$/),n=a?a[1]:e,r=n.match(/^(.+?)(#.+?)?(\?.+)?$/);if(!r)throw new Error("[router5] Could not parse url "+e);var o=r[1],i=r[2]||"",s=r[3]||"";return(t.useHash?i.replace(new RegExp("^#"+t.hashPrefix),""):t.base?o.replace(new RegExp("^"+t.base),""):o)+s}function r(t){return e.matchPath(n(t))}e.urlToPath=n,e.buildUrl=a,e.matchUrl=r}function t(){var t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],o=arguments.length<=1||void 0===arguments[1]?E:arguments[1],i=a.extends({},A,t),s={forceDeactivate:i.forceDeactivate,source:h};return function(t){function u(e,t,a){a?o.replaceState(e,"",t):o.pushState(e,"",t)}function c(e){var i=t.getState(),c=!e.state||!e.state.name,T=c?t.matchPath(o.getLocation(t.routerOptions),h):e.state,l=f.defaultRoute,p=f.defaultParams;return T?void(i&&t.areStatesEqual(T,i,!1)||t.transitionToState(T,i,s,function(e,o){if(e)if(e.redirect){var f=e.redirect,d=f.name,S=f.params;t.navigate(d,S,a.extends({},s,{replace:!0}))}else if(e===n.CANNOT_DEACTIVATE){var E=t.buildUrl(i.name,i.params);c||u(T,E,!0)}else l&&t.navigate(l,p,a.extends({},s,{reload:!0,replace:!0}));else t.invokeEventListeners(r.TRANSITION_SUCCESS,o,i,{replace:!0})})):void(l&&t.navigateToDefault(a.extends({},s,{reload:!0,replace:!0})))}function T(){i.useHash&&!i.base&&(i.base=o.getBase()),o.addPopstateListener(c)}function l(){o.removePopstateListener(c)}function p(e,a,n){var r=o.getState(),i=n.replace||a&&t.areStatesEqual(e,a,!1)||n.reload&&r&&t.areStatesEqual(e,r,!1);u(e,t.buildUrl(e.name,e.params),i)}var f=t.getOptions(),d=t.start;return e(t,i),t.start=function(){for(var e=arguments.length,t=Array(e),a=0;a<e;a++)t[a]=arguments[a];0===t.length||"function"==typeof t[0]?d.apply(void 0,[o.getLocation(i)].concat(t)):d.apply(void 0,t)},t.replaceHistoryState=function(e){var a=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],n=t.buildState(e,a),r=t.buildUrl(e,a);t.lastKnownState=n,o.replaceState(n,"",r)},{onStart:T,onStop:l,onTransitionSuccess:p,onPopState:c}}}var a={};a.extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e};var n={ROUTER_NOT_STARTED:"NOT_STARTED",NO_START_PATH_OR_STATE:"NO_START_PATH_OR_STATE",ROUTER_ALREADY_STARTED:"ALREADY_STARTED",ROUTE_NOT_FOUND:"ROUTE_NOT_FOUND",SAME_STATES:"SAME_STATES",CANNOT_DEACTIVATE:"CANNOT_DEACTIVATE",CANNOT_ACTIVATE:"CANNOT_ACTIVATE",TRANSITION_ERR:"TRANSITION_ERR",TRANSITION_CANCELLED:"CANCELLED"},r={UNKNOWN_ROUTE:"@@router5/UNKNOWN_ROUTE",ROUTER_START:"$start",ROUTER_STOP:"$stop",TRANSITION_START:"$$start",TRANSITION_CANCEL:"$$cancel",TRANSITION_SUCCESS:"$$success",TRANSITION_ERROR:"$$error"},o=function(e){return function(){return e}},i=function(){},s="undefined"!=typeof window&&window.history,u=function(){return window.location.pathname.replace(/\/$/,"")},c=function(e,t,a){return window.history.pushState(e,t,a)},T=function(e,t,a){return window.history.replaceState(e,t,a)},l=function(e){return window.addEventListener("popstate",e)},p=function(e){return window.removeEventListener("popstate",e)},f=function(e){var t=e.useHash?window.location.hash.replace(new RegExp("^#"+e.hashPrefix),""):window.location.pathname.replace(new RegExp("^"+e.base),"");return(t||"/")+window.location.search},d=function(){return window.history.state},S={};S=s?{getBase:u,pushState:c,replaceState:T,addPopstateListener:l,removePopstateListener:p,getLocation:f,getState:d}:{getBase:o(""),pushState:i,replaceState:i,addPopstateListener:i,removePopstateListener:i,getLocation:o(""),getState:o(null)};var E=S,A={forceDeactivate:!0,useHash:!1,hashPrefix:"",base:!1},h="popstate";return t});
!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define("router5ListenersPlugin",n):e.router5ListenersPlugin=n()}(this,function(){"use strict";function e(e){return e.split(".").reduce(function(e,n){return e.concat(e.length?e[e.length-1]+"."+n:n)},[])}function n(e,n){return n._meta&&n._meta[e]?Object.keys(n._meta[e]).reduce(function(e,t){return e[t]=n.params[t],e},{}):{}}function t(t,r){function i(){var e=void 0,i=function(){var o=u[e],i=c[e];if(o!==i)return{v:e};var a=n(o,t),f=n(i,r);if(a.length!==f.length)return{v:e};if(0===a.length)return"continue";var s=Object.keys(a).some(function(e){return f[e]!==a[e]});return s?{v:e}:void 0};for(e=0;e<a;e+=1){var f=i();switch(f){case"continue":continue;default:if("object"===("undefined"==typeof f?"undefined":o.typeof(f)))return f.v}}return e}var u=r?e(r.name):[],c=e(t.name),a=Math.min(u.length,c.length),f=void 0;r?r&&(t.name!==r.name||t._meta&&r._meta)?f=i():(console.log("[router5.transition-path] Some states are missing metadata, reloading all segments"),f=0):f=0;var s=u.slice(f).reverse(),l=c.slice(f),d=r&&f>0?u[f-1]:"";return{intersection:d,toDeactivate:s,toActivate:l}}function r(){var e=arguments.length<=0||void 0===arguments[0]?i:arguments[0];return function(n){function r(e,t){return t?c[e]&&(c[e]=c[e].filter(function(e){return e!==t})):c[e]=[],n}function o(e,t,r){var o=e.replace(/^(\*|\^|=)/,"");if(o&&!/^\$/.test(e)){var i=n.rootNode.getSegmentsByName(o);i||console.warn("No route found for "+o+", listener might never be called!")}return c[e]||(c[e]=[]),c[e]=(r?[]:c[e]).concat(t),n}function i(e,n,t){(c[e]||[]).forEach(function(e){return e(n,t)})}function u(n,o,u){var c=t(n,o),a=c.intersection,f=c.toDeactivate,s=u.reload?"":a,l=n.name;e.autoCleanUp&&f.forEach(function(e){return r("^"+e)}),i("^"+s,n,o),i("="+l,n,o),i("*",n,o)}var c={};return n.getListeners=function(){return c},n.addListener=function(e){return o("*",e)},n.removeListener=function(e){return r("*",e)},n.addNodeListener=function(e,n){return o("^"+e,n,!0)},n.removeNodeListener=function(e,n){return r("^"+e,n)},n.addRouteListener=function(e,n){return o("="+e,n)},n.removeRouteListener=function(e,n){return r("="+e,n)},{onTransitionSuccess:u}}}var o={};o.typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e};var i={autoCleanUp:!0};return r});
